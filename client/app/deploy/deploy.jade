// Copyright (c) TUT Tampere University of Technology 2015-2016
// All rights reserved.
// 
// Main author(s):
// Antti Nieminen <antti.h.nieminen@tut.fi>

div(ng-include='"components/navbar/navbar.html"')

.container(id='r')
  .jumbotron(ng-if="deployments.length", style="text-align:center; padding:24px;")
    | You have staged deployment changes
    br 
    button.btn.btn-default(ng-click="discardDeployment()") Discard
    |  
    button.btn.btn-primary(ng-click="verifyDeployment()") Verify
  .jumbotron(ng-if="updates.length", style="text-align:center; padding:24px;")
    | You have staged updates changes
    br 
    button.btn.btn-default(ng-click="discardUpdate()") Discard
    |  
    button.btn.btn-primary(ng-click="verifyUpdate()") Verify
  .row
    .col-sm-4
      p {{selectedDevices.length}} devices selected
      p
        button.btn.btn-default(ng-disabled="!selectedDevices.length", ng-click="openManageDeployAppsModal()")
          | Deploy Apps
        button.btn.btn-default.navbar-right(ng-disabled="!selectedDevs4Update.length", ng-click="openManageUpdateAppsModal()")
          | Update Apps
      p
        div(ng-if="deploying") 
          p Last deployment progress status:
          uib-progress(max="numDeps")
            uib-bar(value="numSuccessDeps", type="success")
              span(ng-hide="numSuccessDeps==0")
                {{numSuccessDeps}}
            uib-bar(value="numFailDeps", type="danger")
              span(ng-hide="numFailDeps==0")
                {{numFailDeps}}
        div(ng-if="updating") 
          p Last update progress status:
          uib-progress(max="numUps")
            uib-bar(value="numSuccessUps", type="success")
              span(ng-hide="numSuccessUps==0")
                {{numSuccessUps}}
            uib-bar(value="numFailUps", type="danger")
              span(ng-hide="numFailUps==0")
                {{numFailUps}}
        div(ng-if="deleting") 
          p Last delete progress status:
          uib-progress(max="numDels")
            uib-bar(value="numSuccessDels", type="success")
              span(ng-hide="numSuccessDels==0")
                {{numSuccessDels}}
            uib-bar(value="numFailDels", type="danger")
              span(ng-hide="numFailDels==0")
                {{numFailDels}}
      p
        button.btn.btn-danger(ng-if="selectedDevs4Update.length > 0", ng-click="removeApps()")
          i.fa.fa-trash  Delete all apps
      p
        ul.list-group(ng-init="shownIndex = -1")
          li.list-group-item(ng-repeat="device in selectedDevices", ng-click="$parent.shownIndex = $index")
            i.fa {{device.code}} 
            |  
            strong {{device.id}}
            div
              ul.appinfo
                li(ng-repeat="app in device.apps | filter:filterSelApp")
                  strong {{app.name}} {{app.version}}
                  |  {{app.status}}
                  |  
                  a(ng-href="{{deviceManagerUrl}}/devices/{{device.id}}/apps/{{app.id}}/api", target="_blank") API
                  br
                  .btn-group(ng-if="app.status !=='installed'", role="group")
                      a.btn.btn-default(ng-if="app.name.indexOf('liquidiot-')===0", ng-href="/project/{{app.name.slice(10)}}")
                        i.fa.fa-edit
                      button.btn.btn-default(ng-click="openLogModal(device, app)")
                        i.fa.fa-list
                      button.btn.btn-primary(ng-if="app.status==='paused'", ng-click="setAppStatus(device, app, 'running')")
                        i.fa.fa-play
                      button.btn.btn-primary(ng-if="app.status==='running'", ng-click="setAppStatus(device, app, 'paused')")
                        i.fa.fa-pause
                      button.btn.btn-warning(ng-if="app.canRollback", ng-click="rollbackApp(device, app)")
                        i.fa.fa-rotate-left
                      button.btn.btn-success(ng-click="updateApp(device, app)")
                        i.fa.fa-rotate-right
                      button.btn.btn-danger(ng-click="removeApp(device, app)")
                        i.fa.fa-trash
                  i(ng-if="app.status ==='installed'", style="color: red").fa.fa-spinner.fa-pulse.fa-2x.fa-fw
                  span(ng-if="app.status ==='installed'", style="color: red") Trying to run the application
            div
              small
                code(ng-repeat="cls in device.classes") {{cls}}
    .col-sm-8
      p
        | Select a proejct to find compatible target devices
        ul.nya-bs-select(ng-model='selectedProject', title='select a project', data-live-search='true')
          li(nya-bs-option='project in projects')
            a 
              {{project.name}}
              span.glyphicon.glyphicon-ok.check-mark
      p
        | Or query devices:
        //form.form-inline.queryform
        form
          .form-group
            label(for="devicequery") Device:
            input.form-control(id="devicequery", type="text", ng-model="deviceQuery", ng-model-options='{debounce: 200}', ng-change="deselectProject()")
          .form-group
            label(for="appquery") App:
            input.form-control(id="appquery", type="text", ng-model="applicationQuery", ng-model-options='{debounce: 200}', ng-change="deselectProject()")
          .form-group
            button.btn.btn-default(ng-click="manageQuery()")
              i.fa.fa-list
      #network
        vis-network(data="graphData", options="graphOptions", events="graphEvents", component="network")
      p
        .btn-group(role="group")
          button.btn.btn-default(ng-click="loadDevices()")
            span.fa.fa-refresh
          button.btn.btn-default(ng-click="camera.fit()")
            span.fa.fa-arrows-alt  fit camera
          button.btn.btn-default(ng-click="camera.fitOnSelectedNodes()")
            span.fa.fa-arrows-alt  fit camera on selection
          button.btn.btn-default(ng-click="camera.crawl()", ng-show="isCrawlingPossible" )
            span.fa.fa-arrows-alt  crawl in selection


div(ng-include='"components/footer/footer.html"')

// App management (deployment) modal dialog
script(type="text/ng-template", id="managequery.html")
  .modal-header
    button(type="button", class="close", ng-click="cancel()") &times;
    h4.modal-title Query ApplicationsDevices
  .modal-body
    table.table
      thead
        tr
          th Results of Query
          th 
          th Device query
          th 
          th Application Query
        tr(ng-repeat="query in queries")
          td
            form
              .radio
                label Devices
                  input(type="radio", name="resulttype", value="devs", ng-model="query.resultType", ng-change="query.sendQuery()")
              .radio
                label Applications
                  input(type="radio", name="resulttype", value="apps", ng-model="query.resultType", ng-change="query.sendQuery()")
          td {{query.resultName}}
          td
            form
              .form-group
                input.form-control(type="text", id="devquery", ng-model="query.deviceQuery", ng-change="query.sendQuery()")
          td
            form
              .radio
                label and
                  input(type="radio", name="operationtype", value="and", ng-model="query.operationType", ng-change="query.sendQuery()")
              .radio
                label or
                  input(type="radio", name="operationtype", value="or", ng-model="query.operationType", ng-change="query.sendQuery()")
          td
            form
              .form-group
                input.form-control(type="text", id="appquery", ng-model="query.appQuery", ng-change="query.sendQuery()")
    tt {{queries | json}}
    button.btn.btn-default(ng-click="addQuery()") Add Query
  .modal-footer
    button.btn.btn-default(ng-click="done()") Stage deployment

// App management (deployment) modal dialog
script(type="text/ng-template", id="managedeployapps.html")
  .modal-header
    button(type="button", class="close", ng-click="cancel()") &times;
    h4.modal-title Deploy Applications
  .modal-body
    form.form(name="form")
      .form-group
        label(for="selectproject") Deploy application
        |  
        ul.nya-bs-select(ng-model='selectedProject', title='select a project', data-live-search='true')
          li(nya-bs-option='project in projects')
            a 
              {{project.name}}
              span.glyphicon.glyphicon-ok.check-mark
        //select.form-control(id="selectproject", ng-model="selectedProject")
         // option(ng-repeat="project in projects") {{project.name}}
        |  
        label
          span(ng-if="devicequery") to all the devices matching the query
            code  {{devicequery}}
          span(ng-if="!devicequery") to all the devices
          span(ng-if="appquery")  with an app matching
            code {{appquery}}
          | . 
        small  (Approx. {{devices.length}} such devices.)

    .modal-footer
      button.btn.btn-default(ng-disabled="!selectedProject", ng-click="done()") Stage deployment

// App management (deployment) modal dialog
script(type="text/ng-template", id="manageupdateapps.html")
  .modal-header
    button(type="button", class="close", ng-click="cancel()") &times;
    h4.modal-title Update Applications
  .modal-body
    form.form(name="form")
      .form-group
        label(for="selectproject") Update application
        |  
        ul.nya-bs-select(ng-model='selectedProject', title='select a project', data-live-search='true')
          li(nya-bs-option='project in projects')
            a 
              {{project.name}}
              span.glyphicon.glyphicon-ok.check-mark
        //select.form-control(id="selectproject", ng-model="selectedProject")
         // option(ng-repeat="project in projects") {{project.name}}
        |  
        label
          //span(ng-if="devicequery") to all the devices matching the query
            //code  {{devicequery}}
          //span(ng-if="!devicequery") to all the devices
          span(ng-if="appquery")  to all apps with an app matching
            code {{appquery}}
          | . 
        small  (Approx. {{devices.length}} such devices.)

    .modal-footer
      button.btn.btn-default(ng-disabled="!selectedProject", ng-click="done()") Stage update
      
// Verify deployment modal dialog
script(type="text/ng-template", id="verifydeployment.html")
  .modal-header
    button(type="button", class="close", ng-click="cancel()") &times;
    h4.modal-title Deploy
  .modal-body
    ul.list-group
      li.list-group-item(ng-repeat="deployment in deployments")
        | Deploy the latest version of 
        strong {{deployment.project}}
        |  to
        |  
        span(ng-if="deployment.n==='all'") all the 
        span(ng-if="deployment.n!=='all'") {{deployment.n}}
        |  devices matching 
        strong
          code {{deployment.devicequery}}
          |  - 
          code {{deployment.appquery}}
        |  (approx. {{deployment.numApproxDevices}} such devices)
        ul
          li(ng-if="deployment.removeOld")
            | Remove earlier versions of the app
  .modal-footer
    p
      button.btn.btn-default
        i.fa.fa-save
        | 
        | Save for later
      button.btn.btn-primary(ng-click="deploy()")
        i.fa.fa-paper-plane
        | 
        | Deploy

// Verify deployment modal dialog
script(type="text/ng-template", id="verifyupdate.html")
  .modal-header
    button(type="button", class="close", ng-click="cancel()") &times;
    h4.modal-title Update
  .modal-body
    ul.list-group
      li.list-group-item(ng-repeat="update in updates")
        | Update the latest version of 
        strong {{update.project}}
        |  to all the apps matching
        strong
          code {{update.appquery}}
        ul
          li(ng-if="update.removeOld")
            | Remove earlier versions of the app
  .modal-footer
    p
      button.btn.btn-default
        i.fa.fa-save
        | 
        | Save for later
      button.btn.btn-primary(ng-click="update()")
        i.fa.fa-paper-plane
        | 
        | Update

// Application log modal dialog
script(type="text/ng-template", id="applog.html")
  .modal-header
    button(type="button", class="close", ng-click="cancel()") &times;
    h4.modal-title Log of {{app.id}} at {{device.id}}
  .modal-body
    pre
      | {{log}}

